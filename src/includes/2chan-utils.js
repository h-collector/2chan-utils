// ==UserScript==
// @author      h-collector <githcoll@gmail.com>
// @name        2chan-utils
// @namespace   https://gist.github.com/h-collector/
// @description Script for 2chan.net futaba board and archived threads on yakumo-family.com adding useful functions
// @include     http://*.2chan.net/*
// @exclude     http://*.2chan.net/*/src/*
// @include     http://yakumo-family.com/fdat/*
// @include     http://yakumo-family.com/f*dat/*
// @include     http://www.yakumo-family.com/fdat/*
// @include     http://www.yakumo-family.com/f*dat/*
// @require     https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js
// @updateOEX   https://raw.github.com/h-collector/2chan-utils/master/build/2chan-utils.oex
// @homepageURL https://github.com/h-collector/2chan-utils
// @downloadURL https://raw.github.com/h-collector/2chan-utils/master/src/includes/2chan-utils.js
// @updateURL   https://raw.github.com/h-collector/2chan-utils/master/2chan-utils.meta.js
// @history     1.0.7 add some greasemonkey specific things, some changes to image expansion (dimensions display)
// @history     1.0.6 add cached links count, some refactoring, added constriction on max image height/width
// @history     1.0.5 fix: userjs @include/exclude/require declarations (overlay on image page, no www on yakumo-family)
// @history     1.0.4 fix: clicking on image while loading open link, a little code reformat, added more icons
// @history     1.0.3 minor changes
// @history     1.0.2 fixed and improved sidebar, added goto link, fixed autoscroll
// @history     1.0.1 partially fix sideeffect of reverse node traversal on sidebar
// @history     1.0   initial release
// @version     1.0.7
// @date        2013-07-01
// @license     GPL
// @grant       none
// ==/UserScript==
//
//  Features:
//  - inline image expansion, 
//  - inline thread expansion,
//  - expose mailto hidden messages
//  - single post anchoring and post highlight , 
//  - futalog and axfc uploader autolinking with highlight and unique links in sidebar 
//  - page autorefresh on new content, 
//  - removing ads. 
//  To use on opera:   with eg. opera scripter (tested), using converter to oex on opera (tested, also provided .oex build)
//         on firefox: with greasemonkey (tested)
//  Should be used in domready event
!function(){function e(){if(!("console"in window)){var e=["log","error","time","timeEnd"];window.console={};for(var i=0,a=e.length;a>i;++i)window.console[e[i]]=function(){}}if("undefined"==typeof window.jQuery){var o=document.getElementsByTagName("head")[0]||document.documentElement,n=document.createElement("script");n.src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js",n.type="text/javascript",n.onload=function(){t(window.jQuery)},o.appendChild(n)}else t(window.jQuery)}function t(e){function t(e){this.count=e.count||60,this.tick=e.count||60,this.interval=e.interval||1e3,this.ontick=e.ontick||function(){},this.oncomplete=e.oncomplete||function(){}}var i={timeit:!0,constrictWidth:!0,constrictHeight:!0,linkifyAxfc:!0,linkifyFutaba:!0,linkifyPosts:!0};i.timeit&&console.time("2chan-utils"),console.log("jQuery version: "+e().jquery+" Script version: 1.0.6");var a,o,n=e(window);n.resize(function(){a=n.width(),o=n.height()}).triggerHandler("resize"),t.prototype={id:void 0,isRunning:function(){return void 0!==this.id},stop:function(){this.id=clearInterval(this.id)},start:function(e){var t=this;this.id=setInterval(e||function(){t.ontick(--t.tick),t.tick<=0&&(t.tick=t.count,t.oncomplete(t.count))},this.interval)}},e.fn.highlight=function(){return e(this).each(function(){var t=e(this);e("<div/>",{"class":"highlight"}).width(t.outerWidth()).height(t.outerHeight()).css({left:t.offset().left,top:t.offset().top}).appendTo("body").fadeOut(1e3).queue(function(){e(this).remove()})})},String.prototype.replaceArray=function(e,t){for(var i=this,a=0,o=e.length;o>a;a++)i=i.replace(e[a],t[a]);return i},e.fn.searchAndReplace=function(t,i){if(0===this.length||!t||!i)return this;var a=e.isArray(t),o=document.createElement("span"),n=function(e,t,i){if(3===e.nodeType){var r=e.parentNode,s=e.nodeValue;if(o.innerHTML=a?s.replaceArray(t,i):s.replace(t,i),s===o.innerHTML)return;var l=o.childNodes.length;if(l>1){for(;l--;)r.insertBefore(o.firstChild,e);r.removeChild(e)}else r.replaceChild(o.firstChild,e)}else if(1===e.nodeType&&e.childNodes&&!/(script|style)/i.test(e.tagName))for(var c=e.childNodes.length-1;c>=0;--c)n(e.childNodes[c],t,i)};return this.each(function(){n(this,t,i)})},e('<style type="text/css">a.del        { color: #222}a.del:hover  { color: #888}td           { border-radius: 10px}hr           { clear:both;}.expand      { background: url(data:image/gif;base64,R0lGODlhEgASAKEAAAQCBPz+/IQCBJxCPCH5BAEAAAAALAAAAAASABIAAAI7hI+pyycP40ti2IutQBWHkG1O9oUcCWKi0V2len7yDK5ARdOD3VrvxUOZRp4U8FQcsjLMHUUCbUinjQIAOw==) center left no-repeat; }.expanding   { background: url(data:image/gif;base64,R0lGODlhEgASAJEDAJ9AO4AAAP//+v///yH/C05FVFNDQVBFMi4wAwEAAAAh+QQFCgADACwAAAAAEgASAAACO5yPqcsXD+NLAdiLbUAVC5FtTvaFHAliotFdpXp+8gyuQ0XTgN1a78VDmUaeFPBUHLIyzB1FAm1Ip40CACH5BAUKAAMALAQABAAKAAoAAAIThI8JIrp84EOsNmplzNjo6mhGAQAh+QQFCgADACwFAAUACQAJAAACEYQvAomcumB8p0nLTKZUq1wVACH5BAUKAAMALAUABQAJAAkAAAIShASpdtqcDopyUsuke9zqRQEFACH5BAUKAAMALAUABQAJAAkAAAISBCSmhrnskGrtUHmdhQ/qJQEFADs=) left center no-repeat; }td.highlight { background: #eba; }div.highlight{ background: #ff9; position: absolute; opacity: 0.7; z-index: 1000; }a.postanchor { margin: 0 2px; }a.axfc       { background: #eba; }a.futalog    { background: #0e0; }a.axfc,a.futalog,#sidebar a   { display:inline; display:inline-block; padding: 0 4px; text-decoration:none; border-radius:4px;}#sidebar     { padding: 4px; position: fixed; right: 0; overflow: auto; border: 1px solid #a08070; }#sidebar div { text-align:center; font-weight:bold; }#sidebar ul  { padding:0; margin:0; text-align:left; }#sidebar li,.collapse    { background: url(data:image/gif;base64,R0lGODlhEgASAKEAAP///59AO4AAAP//+iH5BAEAAAAALAAAAAASABIAAAI0hI+pyycP40si2IutQDX77XgfJ2ag0ZUaObTuG5xA9dZDTKprqOO8Lkupgj2fQ4JsKJeNAgA7) center left no-repeat; }#sidebar li,.expand, .expanding, .collapse { padding:0; margin:0; padding-left: 20px; cursor:pointer; }#sidebar a   { display:block; height: 22px;}#sidebar li:hover a, a.highlight { background: #ff0;}#stickynav   { background: #eba; text-align:center; position: fixed; top: 50px; right: 10px; }.pointer     { background: #a00; padding:1px; margin:1px; cursor:pointer; display:inline-block; width:14px; height:14px; text-decoration:none; color:#fff; font-size:14px; font-weight:900; border:1px solid #000; border-radius:4px; }.active      { color:#f00; }.resizeable  { width:auto; height:auto; }.loading     { opacity: 0.5; }.overlay-parent { position: relative; display:block; float:left; }.overlay     { position:absolute; z-index:1000; left:20px; opacity: 0.5;background: #00f url(data:image/gif;base64,R0lGODlhKwALAPEAAP///wAAAIKCggAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAKwALAAACMoSOCMuW2diD88UKG95W88uF4DaGWFmhZid93pq+pwxnLUnXh8ou+sSz+T64oCAyTBUAACH5BAkKAAAALAAAAAArAAsAAAI9xI4IyyAPYWOxmoTHrHzzmGHe94xkmJifyqFKQ0pwLLgHa82xrekkDrIBZRQab1jyfY7KTtPimixiUsevAAAh+QQJCgAAACwAAAAAKwALAAACPYSOCMswD2FjqZpqW9xv4g8KE7d54XmMpNSgqLoOpgvC60xjNonnyc7p+VKamKw1zDCMR8rp8pksYlKorgAAIfkECQoAAAAsAAAAACsACwAAAkCEjgjLltnYmJS6Bxt+sfq5ZUyoNJ9HHlEqdCfFrqn7DrE2m7Wdj/2y45FkQ13t5itKdshFExC8YCLOEBX6AhQAADsAAAAAAAAAAAA=) center center no-repeat;}.olinfo      { padding: 4px; background: #00f; color: #fff}.fullimg     { border: 1px solid #f00; }.loaded      { border: 1px dashed #a08070; }.secret      { border: 1px dashed #a08070; }#autoscroll  { display:block; margin:0 2px; width: 34px; border: 1px solid #a08070; }</style>').appendTo("head");var r={su:"nijibox5.com/futabafiles/tubu/src/",sa:"nijibox6.com/futabafiles/001/src/",ss:"nijibox5.com/futabafiles/kobin/src/",sq:"nijibox6.com/futabafiles/mid/src/auth.redirect.php?",sp:"nijibox2.com/futabafiles/003/src/"},s="s[uaspq]",l="[FKOP]|C[al]?|N[ae]?|S[ci]?|A[lr]|Be?|He?|Li|Mg",c=/^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/,d=0,A={},h=e("<ul/>"),p=function(t,i,a){if(A[t]){var o=e("#"+t,h);o!==h.first()&&o.prependTo(h),o.data("anchorId").push(i)}else A[t]=!0,e('<li id="'+t+'"><a'+a+">"+t+"</a></li>").prependTo(h).data("anchorId",[i]);return a};e.fn.processDoc=function(t){i.timeit&&console.time("processing: "+t);var a=e(this),o=[],n=[];i.linkifyPosts&&(o.push(/\bNo\.(\d+)\b/g),n.push('<a href="'+t+'#delcheck$1" class="postanchor">$&</a>')),i.linkifyAxfc&&(o.push(new RegExp("("+l+")_([0-9]{4,8})","g")),n.push(function(e,t,i){return'<a id="a'+ ++d+'"'+p(e,d,' href="http://www1.axfc.net/uploader/'+t+"/so/"+i+'" class="axfc"')+">"+e+"</a>"})),i.linkifyFutaba&&(o.push(new RegExp("("+s+")[0-9]{5,7}","g")),n.push(function(e,t){return'<a id="a'+ ++d+'"'+p(e,d,' href="http://www.'+r[t]+e+'" class="futalog"')+">"+e+"</a>"})),a.css({display:"none"}),a.find("#rightad").remove(),a.find("a").each(function(){var t=this.href;if(!t||0!==t.indexOf("mailto"))return!0;var i=t.substr(7);return"sage"===i||c.test(i)?!0:(e(this).after(e("<span/>",{html:decodeURI(i),"class":"secret"})),void 0)});try{a.searchAndReplace(o,n)}catch(f){console.error(f.stack);var u="There was an error in script.\n\n";u+="Error description: "+f.message+"\n\n",u+="Click OK to continue.\n\n",alert(u)}if(a.css({display:"block"}),h.children().length>0){var g=e("#sidebar");0===g.length&&(g=e("<div/>",{id:"sidebar"}).append(e("<div/>",{text:"Links "}).append(e("<span/>",{id:"dlcount"}))).append(h).appendTo("body"),h.on("mouseenter","li",function(){e.each(e(this).data("anchorId"),function(t,i){e("#a"+i).addClass("highlight")})}).on("mouseleave","li",function(){e.each(e(this).data("anchorId"),function(t,i){e("#a"+i).removeClass("highlight")})}).on("click","a",function(e){e.stopPropagation()}).on("click","li",function(){e("html, body").scrollTop(e("#a"+e(this).data("anchorId").slice(-1)[0]).closest("td").highlight().offset().top)})),e("#dlcount").text("("+function(e){var t,i=0;for(t in e)++i;return i}(A)+"/"+d+")");var v=h.prev().height(),m=e(window).height(),x=Math.min(h.height()+v,m);g.css({top:Math.max(0,(m-x)/2),height:x})}return i.timeit&&console.timeEnd("processing: "+t),a},e("td.chui > div, iframe").remove(),e("#ufm").next("div").remove(),e("hr").next("b").remove();var f=window.location.href.split("#")[0],u=e("form").eq(1);0===u.length&&(u=e("body")),u.processDoc(f);var g=e();u.on("click","a.postanchor",function(){g.removeClass("highlight"),g=e(this.hash).closest("td").addClass("highlight")}),window.location.hash&&(g=e(window.location.hash).closest("td").addClass("highlight")),u.on("click","img",function(t){t.stopPropagation(),t.preventDefault();var n=e(this),r=n.data();if(!r.srcfull){var s=n.parent().attr("href");r.srcfull=s,r.srcalt=s,n.addClass("resizeable").bind("load",function(){var t=e(this),i=t.prev("div.overlay"),a=t[0].naturalWidth,o=t[0].naturalHeight;i.hasClass("olinfo")||i.css({width:"auto",height:"auto"}).addClass("olinfo"),i.text(a+" x "+o),t.attr("src")===t.data("srcfull")?t.addClass("fullimg"):t.removeClass("fullimg")}).bind("error",function(){e(this).prev("div.overlay").hide()}).before(e("<div/>",{"class":"overlay"}).click(function(){return!1}).width(n.outerWidth()).height(n.outerHeight()).show()).parent().addClass("overlay-parent")}var l=r.srcalt;r.srcalt=n.attr("src"),i.constrictWidth&&n.css("max-width",a),i.constrictHeight&&n.css("max-height",o),n.attr("src",l).prev("div.overlay").show()}),u.find("font").filter("[color=#707070]").filter(":contains('レス')").addClass("expand").one("click",function(){var t=e(this),i=t.prevUntil("a:contains('返信'), small").last().prev().get(0);"small"!==i.tagName&&(t.toggleClass("expand expanding").next("br").remove(),e.get(i.href,{},function(a){t.toggleClass("expanding collapse").data("expanded",!0),e(a).filter("form").eq(1).find("table").slice(0,-10).processDoc(i.href).insertAfter(t).wrapAll('<div class="loaded"/>')}))}).click(function(){var t=e(this);t.data("expanded")&&t.toggleClass("collapse expand").next("div.loaded").toggle()});var v=new t({interval:200});e("body").attr("id","top").append(e("<div/>",{id:"btm"})).append(e("<div/>",{id:"stickynav"}).append(e("<a/>",{text:"⬆",href:f+"#top","class":"pointer",title:"Top"})).append(e("<a/>",{text:"⬇",href:f+"#btm","class":"pointer",title:"Bottom"})).append(e("<input/>",{id:"autoscroll",type:"text",value:e("body").height(),title:"Speed"})).on("click","a.pointer",function(t){t.preventDefault(),v.stop();var i=e(this);if(i.hasClass("active"))return i.removeClass("active"),void 0;var a,o,n=i.siblings().removeClass("active").end().addClass("active").get(0).hash,r=parseInt(e("#autoscroll").val()),s=e("html, body");"#top"===n&&(r*=-1),v.start(function(){return a=s.scrollTop()+r,a===o?i.click():(s.scrollTop(o=a),void 0)})}));var m=e("#contres a");if(m.length)for(var x="AutoRefresh=",b=e("<span> 60s</span>").appendTo(e("#contres")),y=new t({count:60,interval:1e3,ontick:function(e){b.text(" "+e+"s")},oncomplete:function(){m.click()}}),w=e("<input/>",{type:"checkbox"}).appendTo(e("<label/>",{text:"[Auto]"}).insertBefore(b)).change(function(){y.isRunning()?(y.stop(),document.cookie=x+":; expires = Thu, 01-Jan-70 00:00:01 GMT; path=/;"):(y.start(),document.cookie=x+"1; path=/;")}),k=document.cookie.split(";"),C=0,Q=k.length;Q>C;C++){for(var E=k[C];" "==E.charAt(0);)E=E.substring(1,E.length);if(0==E.indexOf(x)){w.click();break}}i.timeit&&console.timeEnd("2chan-utils")}"complete"==window.document.readyState?e():window.addEventListener("DOMContentLoaded",e,!1)}();