// ==UserScript==
// @author      h-collector <githcoll@gmail.com>
// @name        2chan-utils
// @namespace   https://gist.github.com/h-collector/
// @description Script for 2chan.net futaba board and archived threads on yakumo-family.com adding useful functions
// @include     http://*.2chan.net/*
// @exclude     http://*.2chan.net/*/src/*
// @include     http://yakumo-family.com/fdat/*
// @include     http://yakumo-family.com/f*dat/*
// @include     http://www.yakumo-family.com/fdat/*
// @include     http://www.yakumo-family.com/f*dat/*
// @require     https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js
// @homepageURL https://gist.github.com/h-collector/5471519#file-2chan-utils-js
// @history     1.0.6 add cached links count, some refactoring, added max height/width
// @history     1.0.5 fix: userjs @include/exclude/require declarations (overlay on image page, no www on yakumo-family)
// @history     1.0.4 fix: clicking on image while loading open link, a little code reformat, added more icons
// @history     1.0.3 minor changes
// @history     1.0.2 fixed and improved sidebar, added goto link, fixed autoscroll
// @history     1.0.1 partially fix sideeffect of reverse node traversal on sidebar
// @history     1.0   initial release
// @version     1.0.6
// @date        2013-05-26
// @license     GPL
// ==/UserScript==
//  Features:
//  - inline image expansion, 
//  - inline thread expansion,
//  - expose mailto hidden messages
//  - single post anchoring and post highlight , 
//  - futalog and axfc uploader autolinking with highlight and unique links in sidebar 
//  - page autorefresh on new content, 
// - removing ads. 
//  To use with eg. opera scripter (tested), or using converter to oex on opera (tested)
//  Should be used in domready event, didn't really try on greasemonkey but should work
!function(){function e(){if(!("console"in window)){var e=["log","error","time","timeEnd"];window.console={};for(var i=0,a=e.length;a>i;++i)window.console[e[i]]=function(){}}if("undefined"==typeof window.jQuery){var o=document.getElementsByTagName("head")[0]||document.documentElement,n=document.createElement("script");n.src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js",n.type="text/javascript",n.onload=function(){t(window.jQuery)},o.appendChild(n)}else t(window.jQuery)}function t(e){function t(e){this.count=e.count||60,this.tick=e.count||60,this.interval=e.interval||1e3,this.ontick=e.ontick||function(){},this.oncomplete=e.oncomplete||function(){}}var i=!0,a=!0,o=!0,n=!0,r=!0,s=!0;i&&console.time("2chan-utils"),console.log("jQuery version: "+e().jquery+" Script version: 1.0.6");var l,d,c=e(window);c.resize(function(){l=c.width(),d=c.height()}).triggerHandler("resize"),t.prototype={id:void 0,isRunning:function(){return void 0!==this.id},stop:function(){this.id=clearInterval(this.id)},start:function(e){var t=this;this.id=setInterval(e||function(){t.ontick(--t.tick),t.tick<=0&&(t.tick=t.count,t.oncomplete(t.count))},this.interval)}},e.fn.highlight=function(){return e(this).each(function(){var t=e(this);e("<div/>",{"class":"highlight"}).width(t.outerWidth()).height(t.outerHeight()).css({left:t.offset().left,top:t.offset().top}).appendTo("body").fadeOut(1e3).queue(function(){e(this).remove()})})},String.prototype.replaceArray=function(e,t){for(var i=this,a=0,o=e.length;o>a;a++)i=i.replace(e[a],t[a]);return i},e.fn.searchAndReplace=function(t,i){if(0===this.length||!t||!i)return this;var a=e.isArray(t),o=document.createElement("span"),n=function(e,t,i){if(3===e.nodeType){var r=e.parentNode,s=e.nodeValue;if(o.innerHTML=a?s.replaceArray(t,i):s.replace(t,i),s===o.innerHTML)return;var l=o.childNodes.length;if(l>1){for(;l--;)r.insertBefore(o.firstChild,e);r.removeChild(e)}else r.replaceChild(o.firstChild,e)}else if(1===e.nodeType&&e.childNodes&&!/(script|style)/i.test(e.tagName))for(var d=e.childNodes.length-1;d>=0;--d)n(e.childNodes[d],t,i)};return this.each(function(){n(this,t,i)})},e('<style type="text/css">a.del {color: #222222} a:hover {color: #888888} td {border-radius: 10px}hr           { clear:both;}.expand      { background: url(data:image/gif;base64,R0lGODlhEgASAKEAAAQCBPz+/IQCBJxCPCH5BAEAAAAALAAAAAASABIAAAI7hI+pyycP40ti2IutQBWHkG1O9oUcCWKi0V2len7yDK5ARdOD3VrvxUOZRp4U8FQcsjLMHUUCbUinjQIAOw==) center left no-repeat; }.expanding   { background: url(data:image/gif;base64,R0lGODlhEgASAJEDAJ9AO4AAAP//+v///yH/C05FVFNDQVBFMi4wAwEAAAAh+QQFCgADACwAAAAAEgASAAACO5yPqcsXD+NLAdiLbUAVC5FtTvaFHAliotFdpXp+8gyuQ0XTgN1a78VDmUaeFPBUHLIyzB1FAm1Ip40CACH5BAUKAAMALAQABAAKAAoAAAIThI8JIrp84EOsNmplzNjo6mhGAQAh+QQFCgADACwFAAUACQAJAAACEYQvAomcumB8p0nLTKZUq1wVACH5BAUKAAMALAUABQAJAAkAAAIShASpdtqcDopyUsuke9zqRQEFACH5BAUKAAMALAUABQAJAAkAAAISBCSmhrnskGrtUHmdhQ/qJQEFADs=) left center no-repeat; }td.highlight { background: #eba; }div.highlight{ background: #ff9; position: absolute; opacity: 0.7; z-index: 1000; }a.postanchor { margin: 0 2px; }a.axfc       { background: #eba; }a.futalog    { background: #0e0; }a.axfc,a.futalog,#sidebar a   { display:inline; display:inline-block; padding: 0 4px; text-decoration:none; border-radius:4px;}#sidebar     { padding: 4px; position: fixed; right: 0; overflow: auto; border: 1px solid #a08070; }#sidebar div { text-align:center; font-weight:bold; }#sidebar ul  { padding:0; margin:0; text-align:left; }#sidebar li,.collapse    { background: url(data:image/gif;base64,R0lGODlhEgASAKEAAP///59AO4AAAP//+iH5BAEAAAAALAAAAAASABIAAAI0hI+pyycP40si2IutQDX77XgfJ2ag0ZUaObTuG5xA9dZDTKprqOO8Lkupgj2fQ4JsKJeNAgA7) center left no-repeat; }#sidebar li,.expand, .expanding, .collapse { padding:0; margin:0; padding-left: 20px; cursor:pointer; }#sidebar a   { display:block; height: 22px;}#sidebar li:hover a, a.highlight { background: #ff0;}#stickynav   { background: #eba; text-align:center; position: fixed; top: 50px; right: 10px; }.pointer     { background: #a00; padding:1px; margin:1px; cursor:pointer; display:inline-block; width:14px; height:14px; text-decoration:none; color:#fff; font-size:14px; font-weight:900; border:1px solid #000; border-radius:4px; }.active      { color:#f00; }.resizeable  { width:auto; height:auto; }.loading     { opacity: 0.5; }.overlay-parent { position: relative; display:block; float:left; }.overlay     { position:absolute; z-index:1000; left:20px; opacity: 0.5;background: #00f url(data:image/gif;base64,R0lGODlhKwALAPEAAP///wAAAIKCggAAACH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAKwALAAACMoSOCMuW2diD88UKG95W88uF4DaGWFmhZid93pq+pwxnLUnXh8ou+sSz+T64oCAyTBUAACH5BAkKAAAALAAAAAArAAsAAAI9xI4IyyAPYWOxmoTHrHzzmGHe94xkmJifyqFKQ0pwLLgHa82xrekkDrIBZRQab1jyfY7KTtPimixiUsevAAAh+QQJCgAAACwAAAAAKwALAAACPYSOCMswD2FjqZpqW9xv4g8KE7d54XmMpNSgqLoOpgvC60xjNonnyc7p+VKamKw1zDCMR8rp8pksYlKorgAAIfkECQoAAAAsAAAAACsACwAAAkCEjgjLltnYmJS6Bxt+sfq5ZUyoNJ9HHlEqdCfFrqn7DrE2m7Wdj/2y45FkQ13t5itKdshFExC8YCLOEBX6AhQAADsAAAAAAAAAAAA=) center center no-repeat;}.olinfo      { padding: 4px; background: #00f; color: #fff}.fullimg     { border: 1px solid #f00; }.loaded      { border: 1px dashed #a08070; }.secret      { border: 1px dashed #a08070; }#autoscroll  { display:block; margin:0 2px; width: 34px; border: 1px solid #a08070; }</style>').appendTo("head");var A={su:"nijibox5.com/futabafiles/tubu/src/",sa:"nijibox6.com/futabafiles/001/src/",ss:"nijibox5.com/futabafiles/kobin/src/",sq:"nijibox6.com/futabafiles/mid/src/auth.redirect.php?",sp:"nijibox2.com/futabafiles/003/src/"},p="s[uaspq]",h="[FKOP]|C[al]?|N[ae]?|S[ci]?|A[lr]|Be?|He?|Li|Mg",u=/^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/,f=0,g={},v=e("<ul/>"),m=function(t,i,a){if(g[t]){var o=e("#"+t,v);o!==v.first()&&o.prependTo(v),o.data("anchorId").push(i)}else g[t]=!0,e('<li id="'+t+'"><a'+a+">"+t+"</a></li>").prependTo(v).data("anchorId",[i]);return a};e.fn.processDoc=function(t){i&&console.time("processing: "+t);var a=e(this),o=[],l=[];s&&(o.push(/\bNo\.(\d+)\b/g),l.push('<a href="'+t+'#delcheck$1" class="postanchor">$&</a>')),n&&(o.push(new RegExp("("+h+")_([0-9]{4,8})","g")),l.push(function(e,t,i){return'<a id="a'+ ++f+'"'+m(e,f,' href="http://www1.axfc.net/uploader/'+t+"/so/"+i+'" class="axfc"')+">"+e+"</a>"})),r&&(o.push(new RegExp("("+p+")[0-9]{5,7}","g")),l.push(function(e,t){return'<a id="a'+ ++f+'"'+m(e,f,' href="http://www.'+A[t]+e+'" class="futalog"')+">"+e+"</a>"})),a.css({display:"none"}),a.find("#rightad").remove(),a.find("a").each(function(){var t=this.href;if(!t||0!==t.indexOf("mailto"))return!0;var i=t.substr(7);return"sage"===i||u.test(i)?!0:(e(this).after(e("<span/>",{html:decodeURI(i),"class":"secret"})),void 0)});try{a.searchAndReplace(o,l)}catch(d){console.error(d.stack);var c="There was an error in script.\n\n";c+="Error description: "+d.message+"\n\n",c+="Click OK to continue.\n\n",alert(c)}if(a.css({display:"block"}),v.children().length>0){var x=e("#sidebar");0===x.length&&(x=e("<div/>",{id:"sidebar"}).append(e("<div/>",{text:"Links "}).append(e("<span/>",{id:"dlcount"}))).append(v).appendTo("body"),v.on("mouseenter","li",function(){e.each(e(this).data("anchorId"),function(t,i){e("#a"+i).addClass("highlight")})}).on("mouseleave","li",function(){e.each(e(this).data("anchorId"),function(t,i){e("#a"+i).removeClass("highlight")})}).on("click","a",function(e){e.stopPropagation()}).on("click","li",function(){e("html, body").scrollTop(e("#a"+e(this).data("anchorId").slice(-1)[0]).closest("td").highlight().offset().top)})),e("#dlcount").text("("+function(e){var t,i=0;for(t in e)++i;return i}(g)+"/"+f+")");var b=v.prev().height(),w=e(window).height(),y=Math.min(v.height()+b,w);x.css({top:Math.max(0,(w-y)/2),height:y})}return i&&console.timeEnd("processing: "+t),a},e("td.chui > div, iframe").remove(),e("#ufm").next("div").remove(),e("hr").next("b").remove();var x=window.location.href.split("#")[0],b=e("form").eq(1);0===b.length&&(b=e("body")),b.processDoc(x);var w=e();b.on("click","a.postanchor",function(){w.removeClass("highlight"),w=e(this.hash).closest("td").addClass("highlight")}),window.location.hash&&(w=e(window.location.hash).closest("td").addClass("highlight")),b.on("click","img",function(t){t.stopPropagation(),t.preventDefault();var i=e(this),n=i.data();if(!n.srcfull){var r=i.parent().attr("href");n.srcfull=r,n.srcalt=r,i.addClass("resizeable").bind("load",function(){var t=e(this),i=t.prev("div.overlay"),a=t[0].naturalWidth,o=t[0].naturalHeight;i.hasClass("olinfo")||i.css({width:"auto",height:"auto"}).addClass("olinfo"),i.text(a+" x "+o),t.attr("src")===t.data("srcfull")?t.addClass("fullimg"):t.removeClass("fullimg")}).bind("error",function(){e(this).prev("div.overlay").hide()}).before(e("<div/>",{"class":"overlay"}).click(function(){return!1}).width(i.outerWidth()).height(i.outerHeight()).show()).parent().addClass("overlay-parent")}var s=n.srcalt;n.srcalt=i.attr("src"),a&&i.css("max-width",l),o&&i.css("max-height",d),i.attr("src",s).prev("div.overlay").show()}),b.find("font").filter("[color=#707070]").filter(":contains('レス')").addClass("expand").one("click",function(){var t=e(this),i=t.prevUntil("a:contains('返信'), small").last().prev().get(0);"small"!==i.tagName&&(t.toggleClass("expand expanding").next("br").remove(),e.get(i.href,{},function(a){t.toggleClass("expanding collapse").data("expanded",!0),e(a).filter("form").eq(1).find("table").slice(0,-10).processDoc(i.href).insertAfter(t).wrapAll('<div class="loaded"/>')}))}).click(function(){var t=e(this);t.data("expanded")&&t.toggleClass("collapse expand").next("div.loaded").toggle()});var y=new t({interval:200});e("body").attr("id","top").append(e("<div/>",{id:"btm"})).append(e("<div/>",{id:"stickynav"}).append(e("<a/>",{text:"⬆",href:x+"#top","class":"pointer",title:"Top"})).append(e("<a/>",{text:"⬇",href:x+"#btm","class":"pointer",title:"Bottom"})).append(e("<input/>",{id:"autoscroll",type:"text",value:e("body").height(),title:"Speed"})).on("click","a.pointer",function(t){t.preventDefault(),y.stop();var i=e(this);if(i.hasClass("active"))return i.removeClass("active"),void 0;var a,o,n=i.siblings().removeClass("active").end().addClass("active").get(0).hash,r=parseInt(e("#autoscroll").val()),s=e("html, body");"#top"===n&&(r*=-1),y.start(function(){return a=s.scrollTop()+r,a===o?i.click():(s.scrollTop(o=a),void 0)})}));var C=e("#contres a");if(C.length)for(var k="AutoRefresh=",Q=e("<span> 60s</span>").appendTo(e("#contres")),E=new t({count:60,interval:1e3,ontick:function(e){Q.text(" "+e+"s")},oncomplete:function(){C.click()}}),I=e("<input/>",{type:"checkbox"}).appendTo(e("<label/>",{text:"[Auto]"}).insertBefore(Q)).change(function(){E.isRunning()?(E.stop(),document.cookie=k+":; expires = Thu, 01-Jan-70 00:00:01 GMT; path=/;"):(E.start(),document.cookie=k+"1; path=/;")}),D=document.cookie.split(";"),B=0,T=D.length;T>B;B++){for(var H=D[B];" "==H.charAt(0);)H=H.substring(1,H.length);if(0==H.indexOf(k)){I.click();break}}i&&console.timeEnd("2chan-utils")}"complete"==window.document.readyState?e():window.addEventListener("DOMContentLoaded",e,!1)}();